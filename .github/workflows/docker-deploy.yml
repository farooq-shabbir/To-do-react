name: Build and Push to Docker Hub

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Build React application
        run: npm run build
      
      - name: Verify build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "ERROR: Build failed - dist folder not found"
            exit 1
          fi
          echo "Build verification successful"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist
            Dockerfile
            nginx.conf
            package.json
            package-lock.json
          retention-days: 7

  test:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run unit tests
        run: npm test
        timeout-minutes: 5
      
      - name: Run ESLint code quality checks
        run: npm run lint

  deploy:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Get short SHA
        id: vars
        run: echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
      
      - name: Build Docker image
        run: |
          # Verify Dockerfile exists
          if [ ! -f "Dockerfile" ]; then
            echo "ERROR: Dockerfile not found"
            exit 1
          fi
          
          # Verify dist folder exists
          if [ ! -d "dist" ]; then
            echo "ERROR: dist folder not found - build artifacts missing"
            exit 1
          fi
          
          # Build image
          docker build -t ${{ secrets.DOCKER_USERNAME }}/todo-react-app:latest .
          docker tag ${{ secrets.DOCKER_USERNAME }}/todo-react-app:latest ${{ secrets.DOCKER_USERNAME }}/todo-react-app:${{ steps.vars.outputs.short_sha }}
          docker tag ${{ secrets.DOCKER_USERNAME }}/todo-react-app:latest ${{ secrets.DOCKER_USERNAME }}/todo-react-app:v1.0.$(date +%Y%m%d)
          
          echo "Docker image built successfully"
          echo "Tags: latest, ${{ steps.vars.outputs.short_sha }}, v1.0.$(date +%Y%m%d)"
      
      - name: Validate Docker image
        run: |
          # Test if image can be run (just verify it starts)
          docker run --rm -d --name test-container ${{ secrets.DOCKER_USERNAME }}/todo-react-app:latest
          sleep 2
          
          # Check if container is running
          if docker ps | grep -q test-container; then
            echo "✓ Container started successfully"
            docker stop test-container
          else
            echo "ERROR: Container failed to start"
            exit 1
          fi
      
      - name: Push Docker image with smart retry
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1
          RETRY_DELAY=15
          PUSH_SUCCESS=false
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "========================================="
            echo "Push Attempt $ATTEMPT of $MAX_ATTEMPTS"
            echo "========================================="
            
            # Attempt push directly
            if docker push ${{ secrets.DOCKER_USERNAME }}/todo-react-app:latest && \
               docker push ${{ secrets.DOCKER_USERNAME }}/todo-react-app:${{ steps.vars.outputs.short_sha }} && \
               docker push ${{ secrets.DOCKER_USERNAME }}/todo-react-app:v1.0.$(date +%Y%m%d); then
              echo "✓ Successfully pushed all tags to Docker Hub!"
              PUSH_SUCCESS=true
              break
            else
              echo "✗ Push failed on attempt $ATTEMPT"
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            
            # If not the last attempt, wait before retry
            if [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ "$PUSH_SUCCESS" = false ]; then
              echo "⏳ Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done
          
          if [ "$PUSH_SUCCESS" = false ]; then
            echo "✗ Failed to push after $MAX_ATTEMPTS attempts"
            exit 1
          fi
      
      - name: Logout from Docker Hub
        if: always()
        run: docker logout

  rollback:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure() && github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Checkout previous commit
        run: |
          PREV_COMMIT=$(git rev-parse HEAD~1)
          echo "Rolling back to commit: $PREV_COMMIT"
          git checkout $PREV_COMMIT
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Build React application (Rollback)
        run: npm run build
      
      - name: Verify rollback build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "ERROR: Rollback build failed - dist folder not found"
            exit 1
          fi
          echo "Rollback build verification successful"
      
      - name: Run unit tests (Rollback)
        run: npm test
        timeout-minutes: 5
      
      - name: Run ESLint (Rollback)
        run: npm run lint
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Get short SHA for previous commit
        id: rollback_vars
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Build Docker image (Rollback)
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/todo-react-app:latest .
          docker tag ${{ secrets.DOCKER_USERNAME }}/todo-react-app:latest ${{ secrets.DOCKER_USERNAME }}/todo-react-app:${{ steps.rollback_vars.outputs.short_sha }}
          docker tag ${{ secrets.DOCKER_USERNAME }}/todo-react-app:latest ${{ secrets.DOCKER_USERNAME }}/todo-react-app:rollback-$(date +%Y%m%d-%H%M%S)
          
          echo "Rollback Docker image built successfully"
      
      - name: Validate Docker image (Rollback)
        run: |
          docker run --rm -d --name test-container-rollback ${{ secrets.DOCKER_USERNAME }}/todo-react-app:latest
          sleep 2
          
          if docker ps | grep -q test-container-rollback; then
            echo "✓ Rollback container started successfully"
            docker stop test-container-rollback
          else
            echo "ERROR: Rollback container failed to start"
            exit 1
          fi
      
      - name: Push rollback image with retry
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1
          RETRY_DELAY=15
          PUSH_SUCCESS=false
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "========================================="
            echo "Push Attempt $ATTEMPT of $MAX_ATTEMPTS"
            echo "========================================="
            
            # Attempt push directly
            if docker push ${{ secrets.DOCKER_USERNAME }}/todo-react-app:latest && \
               docker push ${{ secrets.DOCKER_USERNAME }}/todo-react-app:${{ steps.rollback_vars.outputs.short_sha }} && \
               docker push ${{ secrets.DOCKER_USERNAME }}/todo-react-app:rollback-$TIMESTAMP; then
              echo "✓ Successfully pushed rollback images to Docker Hub!"
              PUSH_SUCCESS=true
              break
            else
              echo "✗ Push failed on attempt $ATTEMPT"
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            
            # If not the last attempt, wait before retry
            if [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ "$PUSH_SUCCESS" = false ]; then
              echo "⏳ Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done
          
          if [ "$PUSH_SUCCESS" = false ]; then
            echo "✗ Failed to push after $MAX_ATTEMPTS attempts"
            exit 1
          fi
      
      - name: Logout from Docker Hub
        if: always()
        run: docker logout
      
      - name: Notify rollback completed
        run: |
          echo "========================================="
          echo "ROLLBACK COMPLETED"
          echo "========================================="
          echo "Pipeline failed, rolled back to previous commit"
          echo "Previous commit: $(git rev-parse HEAD)"
          echo "Rollback image pushed to Docker Hub"

  notify_failure:
    runs-on: ubuntu-latest
    needs: [build, test, deploy, rollback]
    if: always() && (needs.build.result == 'failure' || needs.test.result == 'failure' || needs.deploy.result == 'failure')
    
    steps:
      - name: Pipeline Failed Notification
        run: |
          echo "========================================="
          echo "PIPELINE EXECUTION FAILED"
          echo "========================================="
          echo "Failed Job: Check the workflow run for details"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
